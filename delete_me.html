<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mapbox API</title>

    <!--BOOTSTRAP CDN-->
    <!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">-->
    <link rel="stylesheet" href="https://bootswatch.com/5/quartz/bootstrap.min.css">
    <!--MAPBOX CDN-->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
</head>

<body class="bg-dark">

<!--NAVBAR START-->
<div class="container-fluid d-flex justify-content-between align-items-center">
    <h1 class="text-light">Weather App</h1>
    <div class="container w-25 me-0">
        <p id="city" class="text-secondary text-end" style="font-size: small"></p>
    </div>
</div>
<!--NAVBAR END-->

<!--SEARCH BAR START-->
<div class="container-fluid d-flex justify-content-end">
    <div class="input-group m-3 w-50">
        <input type="text" id="search-input" class="form-control bg-secondary text-dark" placeholder="Search locations..." aria-label="Recipient's username" aria-describedby="button-addon2">
        <button class="btn btn-outline-secondary text-light" type="button" id="search-btn">Find</button>
    </div>
</div>
<!--SEARCH BAR END-->

<!--5DAY FORECAST START-->
<div id="weather" class="container-fluid d-flex justify-content-evenly mb-3" >
</div>
<!--5DAY FORECAST END-->

<!--MAPBOX START-->
<div class="container-fluid">
    <div id='map' style='width: 100%; height: 500px;'></div>
</div>
<!--MAPBOX END-->


<!--JQUERY CDN-->
<script src="https://code.jquery.com/jquery-3.6.1.js" integrity="sha256-3zlB5s2uwoUzrXK3BT7AX3FyvojsraNFxCc2vC/7pNI=" crossorigin="anonymous"></script>
<!--MAPBOX CDN-->
<script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
<!--BOOTSTRAP CDN-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<!--CUSTOM JS SCRIPTS-->
<script src="js/keys.js"></script>
<!--<script src="weather-api.js"></script>-->

<script>
    "use strict";
    //WEATHER API
    let weatherAPI = "http://api.openweathermap.org/data/2.5/forecast"

    //MAPBOX API
    mapboxgl.accessToken = MAPBOX_TOKEN;
    let map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        zoom: 8,
        center: [-96.796856, 32.776272]
    });

    //MAPBOX NAV CONTROLS
    map.addControl(new mapboxgl.NavigationControl())

    //SEARCH BAR FUNCTION
    $('#search-btn').click(() => {
        const search = $('#search-input').val()
        console.log(search)
        geocode(search, mapboxgl.accessToken).then((location) => {

            map.setCenter(location)
            map.setZoom(11)

            let marker = new mapboxgl.Marker({draggable: true})
                .setLngLat([location[0],location[1]])
                .addTo(map)
            // marker.on('dragend', ajaxCall(coordinates));


            ajaxCall(location)
            revGeo(location[0], location[1])
        })

    })

    //WEATHER API AJAX CALL FUNCTION
    let ajaxCall = (arr) => {
        $.get(weatherAPI, {
            APPID: OPEN_WEATHER_APPID,
            lat: arr[1],
            lon: arr[0],
            units: "imperial"
        }).done(function(data) {

            let forecasts = data.list
            let forecastHTML = append(forecasts)
            $('#weather').html(forecastHTML)
            console.log(forecasts)
        })
    }

    //5DAY FORECAST HTML FUNCTION
    let append = (data) => {
        let html = ``
        for  (let i = 0; i < data.length; i += 8){
            console.log("Data: ",data[i])
            const {dt_txt, main: {humidity, temp, temp_max, temp_min}, weather: [{description, icon}], wind: {speed}} = data[i]
            html += `
            <div class="card border-light card " style="width: 20%; eight: ">
               <h6 class="card-header text-center text-dark opacity-75 mb-2" style="font-size: small">${dt_txt.substring(5,7)}.${dt_txt.substring(8,10)}.${dt_txt.substring(0,4)}
               </h6>
               <img src='http://openweathermap.org/img/w/${icon}.png' class="img-thumbnail mx-auto d-block border-0" style='width: 100px; height: 100px;' alt="...">
              <div class="card-body pt-0">
              <h4 class="card-title text-center">${temp.toFixed(1)}ºF</h4>
                <div class="d-flex justify-content-around" >
                <p class="card-text mb-0 text-warning pe-1" style="font-size: small;">
                H:${temp_max.toFixed(1)}ºF
                </p>

                <p class="card-text mb-0 text-warning" style="font-size: small">
                L:${temp_min.toFixed(1)}ºF
                </p>
                </div>

              </div>
              <ul class="list-group list-group-flush text-center">

                <li class="list-group-item text-dark" style="font-size: small">Humidity: ${humidity}%</li>
                <li class="list-group-item text-dark" style="font-size: small">Wind: ${speed} mph</li>
              </ul>
              <div class="card-body p-0 ">
              <p class="list-group-item bg-secondary text-light text-center p-0 m-0">${description.toUpperCase()}</p>
              </div>
            </div>`}
        return html
    }

    //REV-GEO LOCATION DISPLAY FUNCTION
    let revGeo = (lng, lat) => {
        reverseGeocode({lng, lat}, MAPBOX_TOKEN).then(function(results){
            console.log(results)
            $('#city').text(`${results}`)

        })
    }

    //MAPBOX (REVERSE) GEOCODER FUNCTIONS
    function geocode(search, token) {
        let baseUrl = 'https://api.mapbox.com';
        let endPoint = '/geocoding/v5/mapbox.places/';
        return fetch(baseUrl + endPoint + encodeURIComponent(search) + '.json' + "?" + 'access_token=' + token)
            .then(function(res) {
                return res.json();
                // to get all the data from the request, comment out the following three lines...
            }).then(function(data) {
                return data.features[0].center;
            });
    }

    function reverseGeocode(coordinates, token) {
        let baseUrl = 'https://api.mapbox.com';
        let endPoint = '/geocoding/v5/mapbox.places/';
        return fetch(baseUrl + endPoint + coordinates.lng + "," + coordinates.lat + '.json' + "?" + 'access_token=' + token)
            .then(function(res) {
                return res.json();
            })
            // to get all the data from the request, comment out the following three lines...
            .then(function(data) {
                let city
                return data.features[0].place_name
                // .context[2].text;
            });
    }
</script>
</body>
</html>